<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethiopia FAO Policy Dashboard V3</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #0a0a0a;
        }

        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Load the dashboard data -->
    <script src="dashboard_data.js"></script>

    <!-- Main React App -->
    <script type="text/babel">
        const { useState, useMemo } = React;

        // Icon components
        const Search = ({ size = 24, className = "", ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        );

        const Home = ({ size = 24, className = "", ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
        );

        const X = ({ size = 24, className = "", ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );

        const ExternalLink = ({ size = 24, className = "", ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
        );

        const EthiopiaDashboardV3 = () => {
            const [selectedDomain, setSelectedDomain] = useState(null);
            const [selectedAction, setSelectedAction] = useState(null);
            const [hoveredSegment, setHoveredSegment] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [showResults, setShowResults] = useState(false);
            const [activeTab, setActiveTab] = useState('metrics');

            const domainColors = [
                '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
                '#EC4899', '#14B8A6', '#F97316', '#6366F1', '#06B6D4'
            ];

            const dashboardData = window.dashboardData;

            // Shorten unit names
            const shortenUnit = (unit) => {
                if (!unit) return '';

                const unitMap = {
                    'percent': '%',
                    'percentage': '%',
                    'hectare': 'ha',
                    'hectares': 'ha',
                    'kilometer': 'km',
                    'kilometers': 'km',
                    'kilogram': 'kg',
                    'kilograms': 'kg',
                    'meter': 'm',
                    'meters': 'm',
                    'tonne': 't',
                    'tonnes': 't',
                    'million': 'M',
                    'billion': 'B',
                    'thousand': 'K'
                };

                const unitLower = unit.toLowerCase().trim();
                return unitMap[unitLower] || unit;
            };

            // Format numbers smartly
            const formatNumber = (value, unit) => {
                if (!value || value === 'N/A' || value === 'nan') return 'N/A';

                // Try to parse as number
                const num = parseFloat(value);
                if (isNaN(num)) return value + (unit ? ` ${shortenUnit(unit)}` : '');

                // Format large numbers
                let formatted;
                if (num >= 1000000000) {
                    formatted = (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
                } else if (num >= 1000000) {
                    formatted = (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
                } else if (num >= 1000) {
                    formatted = (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
                } else if (num % 1 === 0) {
                    formatted = num.toString();
                } else {
                    formatted = num.toFixed(2).replace(/\.?0+$/, '');
                }

                return formatted + (unit ? ` ${shortenUnit(unit)}` : '');
            };

            const allActions = useMemo(() => {
                return dashboardData.domains.flatMap(domain =>
                    domain.actions.map(action => ({
                        ...action,
                        domain: domain.name
                    }))
                );
            }, []);

            const handleSearch = (term) => {
                setSearchTerm(term);
                if (term.length < 2) {
                    setSearchResults([]);
                    setShowResults(false);
                    return;
                }

                const results = allActions.filter(action =>
                    action.brief.toLowerCase().includes(term.toLowerCase()) ||
                    action.number.toLowerCase().includes(term.toLowerCase())
                );

                setSearchResults(results);
                setShowResults(results.length > 0);
            };

            const selectSearchResult = (action) => {
                const domain = dashboardData.domains.find(d => d.name === action.domain);
                setSelectedDomain(domain);
                setSelectedAction(action);
                setSearchTerm('');
                setShowResults(false);
                setActiveTab('metrics');
            };

            const DonutChart = ({ data, onSliceClick }) => {
                const width = 1300;
                const height = 1300;
                const radius = 450;
                const innerRadius = 260;
                const centerX = width / 2;
                const centerY = height / 2;

                const total = data.reduce((sum, d) => sum + d.total_policies, 0);

                let currentAngle = -Math.PI / 2;
                const slices = data.map((domain, index) => {
                    const percentage = domain.total_policies / total;
                    const angleSize = percentage * 2 * Math.PI;
                    const startAngle = currentAngle;
                    const endAngle = currentAngle + angleSize;
                    const midAngle = startAngle + angleSize / 2;

                    const x1 = centerX + radius * Math.cos(startAngle);
                    const y1 = centerY + radius * Math.sin(startAngle);
                    const x2 = centerX + radius * Math.cos(endAngle);
                    const y2 = centerY + radius * Math.sin(endAngle);
                    const x3 = centerX + innerRadius * Math.cos(endAngle);
                    const y3 = centerY + innerRadius * Math.sin(endAngle);
                    const x4 = centerX + innerRadius * Math.cos(startAngle);
                    const y4 = centerY + innerRadius * Math.sin(startAngle);

                    const largeArcFlag = angleSize > Math.PI ? 1 : 0;

                    const path = `M ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} L ${x3} ${y3} A ${innerRadius} ${innerRadius} 0 ${largeArcFlag} 0 ${x4} ${y4} Z`;

                    const labelRadius = radius + 100;
                    const labelX = centerX + labelRadius * Math.cos(midAngle);
                    const labelY = centerY + labelRadius * Math.sin(midAngle);
                    const textAnchor = labelX > centerX + 10 ? 'start' : labelX < centerX - 10 ? 'end' : 'middle';

                    currentAngle = endAngle;

                    return { path, labelX, labelY, textAnchor, domain, color: domainColors[index], index };
                });

                const hoveredDomain = hoveredSegment !== null ? slices[hoveredSegment].domain : null;

                return (
                    <div className="relative">
                        <svg width={width} height={height} className="mx-auto">
                            <defs>
                                {slices.map((slice, i) => (
                                    <filter key={i} id={`shadow-${i}`}>
                                        <feDropShadow dx="0" dy="4" stdDeviation="6" floodOpacity="0.4"/>
                                    </filter>
                                ))}
                            </defs>

                            {slices.map((slice, index) => (
                                <g key={index}>
                                    <path
                                        d={slice.path}
                                        fill={slice.color}
                                        stroke="#1a1a1a"
                                        strokeWidth="3"
                                        filter={`url(#shadow-${index})`}
                                        className="cursor-pointer transition-all duration-300"
                                        style={{
                                            opacity: hoveredSegment === null || hoveredSegment === index ? 1 : 0.4,
                                            transform: hoveredSegment === index ? 'scale(1.08)' : 'scale(1)',
                                            transformOrigin: `${centerX}px ${centerY}px`
                                        }}
                                        onClick={() => onSliceClick(slice.domain)}
                                        onMouseEnter={() => setHoveredSegment(index)}
                                        onMouseLeave={() => setHoveredSegment(null)}
                                    />

                                    <text x={slice.labelX} y={slice.labelY} textAnchor={slice.textAnchor} className="text-sm font-bold pointer-events-none fill-gray-200">
                                        {slice.domain.name}
                                    </text>
                                    <text x={slice.labelX} y={slice.labelY + 18} textAnchor={slice.textAnchor} className="text-sm pointer-events-none fill-gray-400">
                                        {slice.domain.unique_policies} policies
                                    </text>
                                </g>
                            ))}

                            <circle cx={centerX} cy={centerY} r={innerRadius - 5} fill="#0a0a0a" className="pointer-events-none" />

                            {hoveredDomain ? (
                                <g>
                                    <text x={centerX} y={centerY - 50} textAnchor="middle" className="text-2xl font-bold fill-white">{hoveredDomain.name}</text>
                                    <text x={centerX} y={centerY - 15} textAnchor="middle" className="text-base fill-gray-300">{hoveredDomain.total_actions} Actions</text>
                                    <text x={centerX} y={centerY + 15} textAnchor="middle" className="text-base fill-gray-300">{hoveredDomain.total_policies} Policy Actions</text>
                                    <text x={centerX} y={centerY + 45} textAnchor="middle" className="text-base fill-gray-300">{hoveredDomain.total_metrics} Metrics</text>
                                    <text x={centerX} y={centerY + 80} textAnchor="middle" className="text-sm fill-blue-400 font-semibold">Click to explore →</text>
                                </g>
                            ) : (
                                <g>
                                    <text x={centerX} y={centerY - 35} textAnchor="middle" className="text-3xl font-bold fill-white">Ethiopia</text>
                                    <text x={centerX} y={centerY + 5} textAnchor="middle" className="text-2xl font-bold fill-gray-300">FAO Roadmap</text>
                                    <text x={centerX} y={centerY + 40} textAnchor="middle" className="text-base fill-gray-400">Policy Mapping</text>
                                </g>
                            )}
                        </svg>
                    </div>
                );
            };

            const DomainDetailView = () => {
                const domainIndex = dashboardData.domains.findIndex(d => d.name === selectedDomain.name);
                const domainColor = domainColors[domainIndex];

                return (
                    <div className="grid grid-cols-12 gap-4 h-full">
                        {/* Left Panel - Actions List */}
                        <div className="col-span-4 bg-gray-900 rounded-lg border border-gray-700 overflow-hidden flex flex-col">
                            <div className="p-4 border-b border-gray-700 bg-gradient-to-r from-gray-800 to-gray-900">
                                <h3 className="text-lg font-bold text-white mb-1">{selectedDomain.name}</h3>
                                <p className="text-xs text-gray-400">{selectedDomain.total_actions} Roadmap Actions</p>
                            </div>
                            <div className="flex-1 overflow-y-auto p-2">
                                {selectedDomain.actions.map((action, index) => (
                                    <div
                                        key={index}
                                        onClick={() => {
                                            setSelectedAction(action);
                                            setActiveTab('metrics');
                                        }}
                                        className={`p-3 mb-2 rounded-lg cursor-pointer transition-all ${
                                            selectedAction?.number === action.number
                                                ? 'bg-gradient-to-r from-blue-600 to-blue-700 shadow-lg'
                                                : 'bg-gray-800 hover:bg-gray-750 border border-gray-700'
                                        }`}
                                    >
                                        <div className="flex-1 min-w-0">
                                            <p className={`text-sm font-medium leading-tight ${
                                                selectedAction?.number === action.number ? 'text-white' : 'text-gray-200'
                                            }`}>
                                                {action.brief}
                                            </p>
                                            <div className="flex gap-3 mt-2 text-xs">
                                                <span className={selectedAction?.number === action.number ? 'text-blue-100' : 'text-gray-500'}>
                                                    {action.metric_count} Metrics
                                                </span>
                                                <span className={selectedAction?.number === action.number ? 'text-blue-100' : 'text-gray-500'}>
                                                    {action.policy_count} Policies
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Right Panel - Action Details */}
                        <div className="col-span-8 bg-gray-900 rounded-lg border border-gray-700 overflow-hidden flex flex-col">
                            {selectedAction ? (
                                <>
                                    {/* Action Header */}
                                    <div className="p-4 border-b border-gray-700 bg-gradient-to-r from-gray-800 to-gray-900">
                                        <div className="flex items-start gap-3 mb-3">
                                            <div className="flex-1">
                                                <h3 className="text-lg font-bold text-white">{selectedAction.brief}</h3>
                                            </div>
                                        </div>

                                        {/* Tabs */}
                                        <div className="flex gap-2 bg-gray-800 p-1 rounded-lg w-fit">
                                            <button
                                                onClick={() => setActiveTab('metrics')}
                                                className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                                    activeTab === 'metrics'
                                                        ? 'bg-green-600 text-white shadow-lg'
                                                        : 'text-gray-400 hover:text-white'
                                                }`}
                                            >
                                                Metrics ({selectedAction.metric_count})
                                            </button>
                                            <button
                                                onClick={() => setActiveTab('policies')}
                                                className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                                    activeTab === 'policies'
                                                        ? 'bg-purple-600 text-white shadow-lg'
                                                        : 'text-gray-400 hover:text-white'
                                                }`}
                                            >
                                                Policy Actions ({selectedAction.policy_count})
                                            </button>
                                        </div>
                                    </div>

                                    {/* Tab Content */}
                                    <div className="flex-1 overflow-y-auto">
                                        {activeTab === 'metrics' ? (
                                            <div className="p-4">
                                                {selectedAction.metrics.length > 0 ? (
                                                    <div className="space-y-3">
                                                        {selectedAction.metrics.map((metric, index) => (
                                                            <div key={index} className="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-green-500 transition-colors">
                                                                <div className="flex items-start gap-2 mb-3">
                                                                    <span className="text-green-400 font-bold text-sm flex-shrink-0">#{index + 1}</span>
                                                                    <p className="text-white font-medium">{metric.description}</p>
                                                                </div>
                                                                <div className="grid grid-cols-3 gap-6">
                                                                    <div>
                                                                        <span className="text-gray-500 text-xs block mb-1">Target</span>
                                                                        <span className="text-blue-400 font-bold text-base">{formatNumber(metric.target, metric.units)}</span>
                                                                    </div>
                                                                    <div>
                                                                        <span className="text-gray-500 text-xs block mb-1">Baseline</span>
                                                                        <span className="text-gray-300 font-semibold text-base">{formatNumber(metric.baseline, metric.units)}</span>
                                                                    </div>
                                                                    <div>
                                                                        <span className="text-gray-500 text-xs block mb-1">Target Year</span>
                                                                        <span className="text-orange-400 font-bold text-base">{metric.target_year || 'N/A'}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div className="text-center text-gray-500 py-8">
                                                        No metrics found for this roadmap action.
                                                    </div>
                                                )}
                                            </div>
                                        ) : (
                                            <div className="p-4">
                                                {selectedAction.policies.length > 0 ? (
                                                    <div className="space-y-3">
                                                        {selectedAction.policies.map((policy, index) => (
                                                            <div key={index} className="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-purple-500 transition-colors">
                                                                <div className="flex items-start justify-between gap-3">
                                                                    <div className="flex-1">
                                                                        <div className="flex items-start gap-2 mb-2">
                                                                            <span className="text-purple-400 font-bold text-sm flex-shrink-0">#{index + 1}</span>
                                                                            <p className="text-white font-medium">{policy.description}</p>
                                                                        </div>
                                                                        <div className="flex items-center gap-2 text-xs text-gray-400 mb-2">
                                                                            <span>Source:</span>
                                                                            {policy.document_link ? (
                                                                                <a
                                                                                    href={policy.document_link}
                                                                                    target="_blank"
                                                                                    rel="noopener noreferrer"
                                                                                    className="text-blue-400 hover:text-blue-300 flex items-center gap-1 underline"
                                                                                >
                                                                                    {policy.policy_document}
                                                                                    <ExternalLink size={12} />
                                                                                </a>
                                                                            ) : (
                                                                                <span className="text-gray-400">{policy.policy_document}</span>
                                                                            )}
                                                                        </div>
                                                                        <div className="flex gap-2">
                                                                            {policy.linkage_type && (
                                                                                <span className="text-xs bg-purple-900/50 text-purple-300 px-2 py-1 rounded border border-purple-700">
                                                                                    {policy.linkage_type}
                                                                                </span>
                                                                            )}
                                                                            {policy.instrument_type && (
                                                                                <span className="text-xs bg-blue-900/50 text-blue-300 px-2 py-1 rounded border border-blue-700">
                                                                                    {policy.instrument_type}
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div className="text-center text-gray-500 py-8">
                                                        No policy actions found for this roadmap action.
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </>
                            ) : (
                                <div className="flex items-center justify-center h-full text-gray-500">
                                    <div className="text-center">
                                        <p className="text-lg mb-2">Select a roadmap action</p>
                                        <p className="text-sm text-gray-600">Click on any action from the list to view details</p>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-black p-6">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 rounded-xl shadow-2xl p-6 mb-6 border border-gray-700">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-4xl font-bold text-white mb-2">Ethiopia FAO Policy Mapping</h1>
                                    <p className="text-gray-400 text-lg">Interactive exploration of policy alignment with FAO Global Roadmap</p>
                                </div>
                                {selectedDomain && (
                                    <button
                                        onClick={() => {
                                            setSelectedDomain(null);
                                            setSelectedAction(null);
                                        }}
                                        className="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-lg"
                                    >
                                        <Home size={20} />
                                        Back to Domains
                                    </button>
                                )}
                            </div>

                            {/* Search Bar */}
                            {!selectedDomain && (
                                <div className="mt-6 relative">
                                    <div className="relative">
                                        <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500" size={20} />
                                        <input
                                            type="text"
                                            placeholder="Search actions by keyword (e.g., 'livestock', 'genetics', 'breeding')..."
                                            value={searchTerm}
                                            onChange={(e) => handleSearch(e.target.value)}
                                            className="w-full pl-12 pr-10 py-3 bg-gray-800 border-2 border-gray-700 rounded-lg focus:border-blue-500 focus:outline-none text-white placeholder-gray-500"
                                        />
                                        {searchTerm && (
                                            <button
                                                onClick={() => {
                                                    setSearchTerm('');
                                                    setShowResults(false);
                                                }}
                                                className="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-300"
                                            >
                                                <X size={18} />
                                            </button>
                                        )}
                                    </div>

                                    {showResults && (
                                        <div className="absolute top-full left-0 right-0 mt-2 bg-gray-900 border-2 border-blue-500 rounded-lg shadow-2xl z-50 max-h-96 overflow-y-auto">
                                            <div className="p-2">
                                                <div className="text-sm text-gray-400 px-3 py-2 font-medium">
                                                    Found {searchResults.length} action{searchResults.length !== 1 ? 's' : ''}
                                                </div>
                                                {searchResults.map((action, index) => (
                                                    <div
                                                        key={index}
                                                        onClick={() => selectSearchResult(action)}
                                                        className="p-3 hover:bg-gray-800 rounded-lg cursor-pointer transition-colors"
                                                    >
                                                        <div className="flex items-start gap-3">
                                                            <span className="px-2 py-1 bg-blue-600 text-white rounded text-xs font-bold flex-shrink-0">
                                                                {action.number}
                                                            </span>
                                                            <div className="flex-1">
                                                                <div className="font-semibold text-white">{action.brief}</div>
                                                                <div className="text-xs text-gray-400 mt-1">
                                                                    {action.domain} • {action.policy_count} policies • {action.metric_count} metrics
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Main Content Area */}
                        <div className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl shadow-2xl p-8 border border-gray-700" style={{ minHeight: '600px' }}>
                            {!selectedDomain ? (
                                <div>
                                    <div className="text-center mb-8">
                                        <h2 className="text-2xl font-bold text-white mb-2">FAO Domains Overview</h2>
                                        <p className="text-gray-400">Hover over a domain • Click to explore actions</p>
                                    </div>
                                    <DonutChart
                                        data={dashboardData.domains}
                                        onSliceClick={(domain) => {
                                            setSelectedDomain(domain);
                                            setSelectedAction(null);
                                        }}
                                    />
                                </div>
                            ) : (
                                <DomainDetailView />
                            )}
                        </div>

                        {/* Footer */}
                        <div className="mt-6 text-center">
                            <div className="bg-gray-900 rounded-lg shadow-lg p-4 inline-block border border-gray-700">
                                <p className="text-sm text-gray-400">
                                    <strong className="text-gray-300">Data Source:</strong> FAO Ethiopia Policy Document Analysis • <strong className="text-gray-300">Last updated:</strong> November 2024
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<EthiopiaDashboardV3 />, document.getElementById('root'));
    </script>
</body>
</html>
